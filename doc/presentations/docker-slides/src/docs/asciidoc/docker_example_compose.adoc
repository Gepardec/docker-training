= Docker Compose Example
Thomas Herzog
2018-11-09
:author: Thomas Herzog
:revnumber: {project-version}
:example-caption!:
ifndef::imagesdir[:imagesdir: images]
ifndef::sourcedir[:sourcedir: ../../main/java]
:title-slide-background-image: 70s.jpg
:title-slide-transition: zoom
:title-slide-transition-speed: fast
:customcss: slides.css
:source-highlighter: highlightjs

== What do we want to learn?

image:docker_example_complex.svg[title="Complex example",caption="Complex example",align=center]

[.text-left]
* How to define a __docker-compose.yml__ 
* How to use Docker Networks/Volumes
* How to Backup/Restore a Docker Container
* Reproducibility, running in parallel

=== What is Docker Compose

[source,bash]
----
version: '3'
services:
  frontend:
    ...
  backend:
    ...
  database:
    ....
----

* Tool for running multi container apps
* Defined with the YAML file docker-compose.yml
* Add container managed at once

=== The example

* The application is well known __todo__ application
* The __todo__ application needs these env vars: 
** __DB_USER__, __DB_PASSWORD__
** __DB_URL__=jdbc:mysql://host:port/db
* The host running the Docker Container must have internet access
* The MariaDb Docker Image: link:https://hub.docker.com/_/mariadb/[]

== The Docker Volume

[source,bash]
-----
version: '3'
...
-----

[.text-left]
* Define a Docker Volume and name it __todo-db-vol__ 

=== Solution

[source,bash]
----
version: '3'
include::./examples/compose/simple/docker-compose.yml[tag=volume]
----


== The Docker Network

[source,bash]
-----
version: '3'
...
-----

[.text-left]
* Define a Docker Network and name it __todo-net__ 

=== Solution

[source,bash]
----
version: '3'
include::./examples/compose/simple/docker-compose.yml[tag=net]
----

== The todo-db service

[source,bash]
-----
version: '3'
services:
...
-----

[.text-left]
* Define the __todo-db__ service 

=== Solution

[source,bash]
----
version: '3'
services:
include::./examples/compose/simple/docker-compose.yml[tag=db]
----

== The todo-app service

[source,bash]
-----
version: '3'
services:
...
-----

* The Docker Image shall be build by docker-compose!
* Just reuse the Dockerfile of the complex example

[.text-left]
* Define the __todo-app__ service 

=== Solution

[source,bash]
----
version: '3'
services:
include::./examples/compose/simple/docker-compose.yml[tag=app]
----

== Backup the database

[source, bash]
-----
# 1. Stop the Docker Containers
docker-compose ...

# 2. Backup the database
docker run ...

# 3. Start the Docker Containers
docker-compose ...
-----

* Create entries in the todo app
* Perform a backup

=== Solution

[source, bash]
-----
include::./examples/compose/simple/commands.sh[tag=backup]
-----

== Restore the database

[source, bash]
-----
# 1. Stop the Docker Containers
docker-compose ...

# 2. Restore the database
docker run ...

# 3. Start the Docker Containers
docker-compose ...
-----

* Create entries in the todo app
* Perform a restore

=== Solution

[source, bash]
-----
include::./examples/compose/simple/commands.sh[tag=restore]
-----

== Add healthchecks and restart

[source, bash]
-----
# Test for healthy database
test: ["CMD", "mysql", \
       "--host=localhost", "--database=todo", \
       "-utodo", "-ptodo", "-e", "Select 1"]

# Test for healthy todo-app
test: ["CMD", "wget", \
       "http://localhost:8080/health"]
-----

* The test array needs to be inline!!!!!!
* Add an healthcheck and restart to the __todo-app__
* Add an healthcheck and restart to the __todo-db__

=== Solution todo-db

[source,bash]
----
version: '3'
services:
  todo-db:
include::./examples/compose/simple/docker-compose-health.yml[tag=dbhealth]
----

=== Solution todo-app

[source,bash]
----
version: '3'
services:
  todo-app:
include::./examples/compose/simple/docker-compose-health.yml[tag=apphealth]
----

== Deploy a second infrastructure

* Create a second infrastructure project
* Make modifications to run them in parallel
* Run them in parallel
* Backup one __todo-db__ service and restore in the other infra.

=== Solution

. Copy __infra-1__ to __infra-2__
. Change __todo-app__ port to *9080* of infra-2
. Start both infras with ``docker-compose up``
. Perform backup on infra-1 __todo-db__
. Perform restore on infra-2 __todo-db__


== Extract parameters

* Find out how to provide external properties
* Extract all variables from docker-compose.yml
* Provide property values for two infras

=== Solution 

[source,bash]
----
include::./examples/compose/infra-3/.env[]
----

[source,bash]
----
version: '3'
services:
  todo-app:
include::./examples/compose/infra-3/docker-compose.yml[tag=param]
----

* Extract all parameters to a file names __.env__
* Use the variables like this __$PARAM_1__ or __${PARAM_1}__

== Cleanup

* Clean up your workspace

=== Solution

[source, bash]
-----
include::./examples/compose/simple/commands.sh[tag=cleanup]
-----