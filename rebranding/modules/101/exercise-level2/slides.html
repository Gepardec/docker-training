<section>
    <section>
        <h2>Excercise<br>Level 2</h2>
    </section>

    <section>
        <h2>What do we want to learn?</h2>
        <img src='images/docker_example_complex.svg'></img>
        <br>
        <ul>
            <li>How to define a docker-compose.yml </li>
            <li>How to use Docker Networks/Volumes</li>
            <li>How to Backup/Restore a Docker Container</li>
            <li>Reproducibility, running in parallel</li>
        </ul>       
        <aside class="notes">
        </aside>
    </section>

    <section>
        <h2>What is Docker Compose</h2>
        <div class="pre">version: '3'
services:
  frontend:
    ...
  backend:
    ...
  database:
    ....</div>
        <br>
        <ul>
            <li>Tool for running multi container apps</li>
            <li>Defined with the YAML file docker-compose.yml</li>
            <li>Add container managed at once</li>
        </ul>       
        <aside class="notes">
        </aside>
    </section>

    <section>
        <h2>The example</h2>
        <ul>
            <li>The application is a todo application</li>
            <li>The todo application needs these env vars: 
                <ul>
                    <li>DB_USER,DB_PASSWORD</li>
                    <li>DB_URL=jdbc:mysql://[host]:[port]/[db]</li>
                </ul>
            </li>
            <li>The host running the Docker Container must have internet access</li>
            <li>The MariaDb Docker Image: <a href="https://hub.docker.com/_/mariadb/">https://hub.docker.com/_/mariadb/</a></li>
        </ul>       
        <aside class="notes">
        </aside>
    </section>

    <section>
        <h2>Preparations</h2>
        <ul>
            <li>Create the directory compose-example-1/todo-app</li>
            <li>Copy the app.jar to directory todo-app</li>
            <li>Copy the Dockerfile for todo-ap to directory todo-app</li>
            <li>Create a file named commands.sh</li>
            <li>Create a file named docker-compose.yml</li>
        </ul>       
        <aside class="notes">
        </aside>
    </section>

    <section>
        <h2>The Docker Volume</h2>
        <div class="pre">version: '3'
...</div>
        <br>
        <ul>
            <li>Define the Docker Volume todo-db-vol in the docker-compose.yml </li>
            <li>Test the definition by executing 
                <ul>
                    <li><code>docker-compose up</code></li>
                    <li><code>docker-compose down -v</code></li>
                </ul>
            </li>
        </ul>       
        <aside class="notes">
        </aside>
    </section>

    <section>
        <h2>Solution</h2>
        <div class="pre">version: '3'
  volumes:
    todo-db-vol:</div>
        <aside class="notes">
        </aside>
    </section>

    <section>
        <h2>The Docker Network</h2>
        <div class="pre">version: '3'
...</div>
        <br>
        <ul>
            <li>Define the Docker Network todo-net in the docker-compose.yml</li>
            <li>Test the definition by executing 
                <ul>
                    <li><code>docker-compose up</code></li>
                    <li><code>docker-compose down -v</code></li>
                </ul>
            </li>
        </ul>       
        <aside class="notes">
        </aside>
    </section>

    <section>
        <h2>Solution</h2>
        <div class="pre">version: '3'
  networks:
    todo-net:</div>
        <aside class="notes">
        </aside>
    </section>

    <section>
        <h2>The todo-db service</h2>
        <div class="pre">version: '3'
services:
...</div>
        <br>
        <ul>
            <li>Define the Service todo-db in the docker-compose.yml</li>
            <li>Test the definition by executing 
                <ul>
                    <li><code>docker-compose up</code></li>
                    <li><code>docker-compose down -v</code></li>
                </ul>
            </li>
        </ul>       
        <aside class="notes">
        </aside>
    </section>

    <section>
        <h2>Solution</h2>
        <div class="pre">version: '3'
  services:
    todo-db:
      image: library/mariadb:latest
      environment:
        - MYSQL_ROOT_PASSWORD=todo
        - MYSQL_DATABASE=todo
        - MYSQL_USER=todo 
        - MYSQL_PASSWORD=todo 
      networks:
        - todo-net
      volumes: 
        - todo-db-vol:/var/lib/mysql</div>
        <aside class="notes">
        </aside>
    </section>

    <section>
        <h2>The todo-app service</h2>
        <div class="pre">version: '3'
services:
...</div>
        <br>
        <ul>
            <li>Define the Service todo-app in the docker-compose.yml</li>
            <li>Docker Compose shall build the image for us</li>
            <li>Test the definition by executing 
                <ul>
                    <li><code>docker-compose up</code></li>
                    <li><code>docker-compose down -v</code></li>
                </ul>
            </li>
        </ul>       
        <aside class="notes">
        </aside>
    </section>

    <section>
        <h2>Solution</h2>
        <div class="pre">version: '3'
services:
  todo-app:
    build:
      context: ./todo-app 
    environment:
      - DB_URL=jdbc:mysql://todo-db:3306/todo
      - DB_USER=todo 
      - DB_PASSWORD=todo
    networks:
      - todo-net
    ports:
      - 8080:8080
    depends_on:
      - todo-db</div>
        <br>
        <ul>
        </ul>       
        <aside class="notes">
        </aside>
    </section>

    <section>
        <h2>Backup the database</h2>
        <div class="pre"># 1. Stop the Docker Containers
docker-compose ...

# 2. Backup the database
docker run ...

# 3. Start the Docker Containers
docker-compose ...</div>
        <br>
        <ul>
            <li>Start your infrastructure</li>
            <li>Create entries in the todo app</li>
            <li>Write the command for stopping the Docker Containers</li>
            <li>Write the command for running a backup Docker Container</li>
            <li>Write the command for starting the Docker Containers</li>
        </ul>       
        <aside class="notes">
        </aside>
    </section>

    <section>
        <h2>Solution</h2>
        <div class="pre"># 1. Stop/Delete the Docker Containers
docker-compose down

# 2. Backup the database
# Be aware of the directory prefix!!!
docker run --rm \
    --volume simple_todo-db:/var/lib/mysql \
    --volume $(pwd):/backup \
    alpine tar cvf /backup/backup.tar -C /var/lib/mysql .
    
# Create/Start the Docker Containers
docker-compose up -d</div>
        <br>
        <ul>
        </ul>       
        <aside class="notes">
        </aside>
    </section>

    <section>
        <h2>Restore the database</h2>
        <div class="pre"># 1. Stop the Docker Containers
docker-compose ...

# 2. Restore the database
docker run ...

# 3. Start the Docker Containers
docker-compose ...</div>
        <br>
        <ul>
            <li>Clear the infrastructure by executing <code>docker-compose down -v</code></li>
            <li>Write the command for stopping the Docker Containers</li>
            <li>Write the command for running a restoring Docker Container</li>
            <li>Write the command for starting the Docker Containers</li>
        </ul>       
        <aside class="notes">
        </aside>
    </section>

    <section>
        <h2>Solution</h2>
        <div class="pre"># 1. Stop/Delete the Docker Containers
docker-compose down

# 2. Perform the restore
# Be aware of the directory prefix!!!
docker run --rm \
    --volume simple_todo-db:/var/lib/mysql \
    --volume $(pwd):/restore \
    alpine sh -c "rm -rf /var/lib/mysql/* \
    && tar xvf /restore/backup.tar -C /var/lib/mysql --strip 1"
    
# 3. Create/Start the Docker Containers 
docker-compose up -d</div>
        <aside class="notes">
        </aside>
    </section>

    <section>
        <h2>Add healthchecks and restart</h2>
        <div class="pre"># Test for healthy database
test: ["CMD", "mysql", \
       "--host=localhost", "--database=todo", \
       "-utodo", "-ptodo", "-e", "Select 1"]

# Test for healthy todo-app
test: ["CMD", "wget", \
       "http://localhost:8080/health"]</div>
        <br>        
        <ul>
            <li>The test array needs to be inline!!!!!!</li>
            <li>Define an healthcheck and restart to the todo-app</li>
            <li>AddDefine an healthcheck and restart to the todo-db</li>
            <li>Test the definition by executing 
                <ul>
                    <li><code>docker-compose up</code></li>
                    <li><code>docker-compose ps</code></li>
                </ul>
            </li>
        </ul>       
        <aside class="notes">
        </aside>
    </section>

    <section>
        <h2>Solution todo-db</h2>
        <div class="pre">version: '3'
services:
  todo-db:
    healthcheck:
      test: ["CMD", "mysql", "--host=localhost", "--database=todo", "-utodo", "-ptodo", "-e", "Select 1"]
      interval: 2s
      timeout: 11s
      retries: 5
    restart: on-failure</div>
        <aside class="notes">
        </aside>
    </section>

    <section>
        <h2>Solution todo-app</h2>
        <div class="pre">version: '3'
services:
  todo-app:
    healthcheck:
      test: ["CMD", "wget", 'http://localhost:8080/health']
      interval: 2s
      timeout: 31s
      retries: 15
    restart: always</div>   
        <aside class="notes">
        </aside>
    </section>

    <section>
        <h2>Deploy a second infrastructure</h2>
        <ul>
            <li>Copy the directory compose-example-1  to compose-example-2 </li>
            <li>Find out what needs to be changed, and do it</li>
            <li>Start both infrastructures with <code>docker-compose up</code></li>
            <li>Backup compose-example-1 todo-db</li>
            <li>Restore in compose-example-2  todo-db</li>    
        </ul>       
        <aside class="notes">
        </aside>
    </section>

    <section>
        <h2>Solution</h2>
        <ul>
            <li>Change todo-app port to 9080  of compose-example-2 </li>
            <li>Perform backup on compose-example-1 todo-db</li>
            <li>Perform restore on compose-example-2 todo-db</li>   
        </ul>       
        <aside class="notes">
        </aside>
    </section>

    <section>
        <h2>Extract parameters</h2>
        <ul>
            <li>Find out how to provide external properties</li>
            <li>Extract all variables from docker-compose.yml</li>
            <li>Provide property values for two infras</li>
        </ul>       
        <aside class="notes">
        </aside>
    </section>

    <section>
        <h2>Solution</h2>
        <div >
            <div class="pre" style="vertical-align:top;"># in your CLI
TODO_DB_PWD=todo
TODO_DB_USR=todo
TODO_DB_DB=todo
TODO_APP_PORT=9090</div>
            <div class="pre"># docker-compose.yml
version: '3'
services:
  todo-app:
    environment:
      - DB_URL=jdbc:mysql://todo-db:3306/${TODO_DB_DB}
      - DB_USER=${TODO_DB_USR} 
      - DB_PASSWORD=${TODO_DB_PWD}
    networks:
      - todo-net
    ports:
      - ${TODO_APP_PORT}:8080</div>
        </div>
        <br>
        <ul>
            <li>Extract all parameters to a file named .env </li>
            <li>Use the variables like this <code>$PARAM_1</code> or <code>${PARAM_1}</code></li>
        </ul>       
        <aside class="notes">
        </aside>
    </section>

    <section>
        <h2>Cleanup</h2>
        <ul>
            <li>Clean up your workspace</li>
        </ul>       
        <aside class="notes">
        </aside>
    </section>

    <section>
        <h2>Solution</h2>
        <ul>
            <li><code>docker-compose down -v</code></li>
        </ul>
        <aside class="notes">
        </aside>
    </section>

</section>